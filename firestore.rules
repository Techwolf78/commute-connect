rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Rides are publicly readable, but only creators can modify
    match /rides/{rideId} {
      allow read: if true;
      allow write: if request.auth != null && resource.data.driverId == request.auth.uid;
    }

    // Bookings: users can read their own, drivers can read for their rides
    match /bookings/{bookingId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.passengerId ||
         exists(/databases/$(database)/documents/rides/$(resource.data.rideId)) &&
         get(/databases/$(database)/documents/rides/$(resource.data.rideId)).data.driverId == request.auth.uid);
      allow write: if request.auth != null && request.auth.uid == resource.data.passengerId;
    }

    // Drivers: only the driver can read/write their data
    match /drivers/{driverId} {
      allow read, write: if request.auth != null && request.auth.uid == driverId;
    }

    // Vehicles: only the owner can read/write
    match /vehicles/{vehicleId} {
      allow read, write: if request.auth != null && resource.data.driverId == request.auth.uid;
    }

    // Ratings: read/write based on booking permissions
    match /ratings/{ratingId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        exists(/databases/$(database)/documents/bookings/$(resource.data.bookingId)) &&
        get(/databases/$(database)/documents/bookings/$(resource.data.bookingId)).data.passengerId == request.auth.uid;
    }

    // Chats: participants can read/write
    match /chats/{chatId} {
      allow read, write: if request.auth != null &&
        request.auth.uid in resource.data.participants;
    }

    // Messages: participants of the chat can read/write
    match /messages/{messageId} {
      allow read, write: if request.auth != null &&
        exists(/databases/$(database)/documents/chats/$(resource.data.chatId)) &&
        request.auth.uid in get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data.participants;
    }

    // Notifications: users can read/write their own
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }
  }
}